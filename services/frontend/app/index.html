<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Transcendence</title>
	</head>
	<body>
		<nav>
			<ul id="menu"></ul>
		</nav>
		<div id="content"></div>
		<script src="urlRouter.js"></script>

		<canvas
			id="pong"
			width="1000"
			height="538"
			style="background: black; display: block; margin: auto"
		></canvas>
		<a href="/auth-google/login/google">Google Login</a>

		<hr />
		<section
			id="login-section"
			style="max-width: 480px; margin: 16px auto; font-family: sans-serif"
		>
			<h2>Login</h2>
			<form id="login-form">
				<label>
					Login
					<input type="text" id="login" name="login" required minlength="4" />
				</label>
				<br />
				<label>
					Password
					<input
						type="password"
						id="password"
						name="password"
						required
						minlength="4"
					/>
				</label>
				<br />
				<button type="submit">Sign in</button>
			</form>
			<pre
				id="login-result"
				style="
					background: #111;
					color: #0f0;
					padding: 8px;
					white-space: pre-wrap;
				"
			></pre>

			<!-- 2FA controls integrated in the main frontend -->
			<div style="margin-top:12px">
				<button id="btn-2fa-setup">Activer 2FA (setup)</button>
				<div id="setup-result" style="margin-top:8px"></div>
				<div style="margin-top:8px">
					<label>Code 2FA <input type="text" id="twofa-code" maxlength="6" /></label>
					<button id="btn-2fa-verify">Vérifier 2FA</button>
					<div id="verify-result" style="margin-top:8px"></div>
				</div>
			</div>

			<div style="margin-top: 8px">
				<strong>Protected links (require admin cookie):</strong>
				<ul>
					<li><a href="/auth/docs/" target="_blank">Auth docs</a></li>
					<li><a href="/users/docs/" target="_blank">Users docs</a></li>
					<li><a href="/prometheus/" target="_blank">Prometheus</a></li>
					<li><a href="/grafana/" target="_blank">Grafana</a></li>
					<li><a href="/alertmanager/" target="_blank">Alertmanager</a></li>
					<li><a href="/mtail/" target="_blank">mtail</a></li>
				</ul>
			</div>
		</section>

		<script>
			// This function checks the current url and takes the query parameters
			function getUrlVars() {
				var url = window.location.href
				var vars = {}
				var hashes = url.split('?')[1]
				if (!hashes) return vars
				var hash = hashes.split('&')
				for (var i = 0; i < hash.length; i++) {
					var params = hash[i].split('=')
					vars[params[0]] = params[1]
				}
				return vars
			}

			// This function create a new cookie (not used for httpOnly cookies)
			function setCookie(cname, cvalue, exdays) {
				const d = new Date()
				d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000)
				let expires = 'expires=' + d.toUTCString()
				document.cookie = cname + '=' + cvalue + ';' + expires + ';path=/'
			}

			// Google login callback support
			if (getUrlVars()['access_token']) {
				setCookie('google_access_token', getUrlVars()['access_token'], 1)
				console.log('Logged in successfully!')
			}

			// Handle login form submit
			document
				.getElementById('login-form')
				.addEventListener('submit', async (e) => {
					e.preventDefault()
					const login = document.getElementById('login').value
					const password = document.getElementById('password').value
					const out = document.getElementById('login-result')
					out.textContent = 'Logging in...'
					try {
						const res = await fetch('/auth/api/login', {
							method: 'POST',
							credentials: 'include',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ login, password })
						})
						const data = await res.json().catch(() => ({}))
						if (!res.ok) {
							out.textContent = 'Login failed: ' + (data.error || res.status)
							return
						}
						// Show token info (header.payload only)
						let payload = {}
						try {
							payload = JSON.parse(atob((data.token || '').split('.')[1] || ''))
						} catch {}
						if (data.pre_2fa_required) {
							out.textContent = '2FA required. Please verify using the code.'
							// keep pre_2fa token in cookie (httpOnly) set by backend
						} else {
							out.textContent = 'Login OK\n' + JSON.stringify({ payload }, null, 2)
						}
					} catch (err) {
						out.textContent = 'Error: ' + (err && err.message ? err.message : err)
					}
				})

			// 2FA setup handler
			document.getElementById('btn-2fa-setup').addEventListener('click', async () => {
				const out = document.getElementById('setup-result')
				out.textContent = 'Génération en cours...'
				try {
					const res = await fetch('/auth/api/2fa/setup', {
						method: 'POST',
						credentials: 'include',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({})
					})
					const json = await res.json().catch(() => ({}))
					if (!res.ok) { out.textContent = 'Erreur: ' + (json.error || res.status); return }
					let html = ''
					if (json.qr_base64) html += `<img id="qr" src="${json.qr_base64}" alt="QR" />`
					if (json.otpauth_url) html += `<p>otpauth_url: <code>${json.otpauth_url}</code></p>`
					if (json.expires_at) html += `<p>Expire: ${json.expires_at}</p>`
					html += `<p>Après scan, entrez le code dans Vérifier 2FA.</p>`
					out.innerHTML = html
				} catch (e) { out.textContent = 'Erreur: ' + e.message }
			})

			// 2FA verify handler
			document.getElementById('btn-2fa-verify').addEventListener('click', async () => {
				const code = document.getElementById('twofa-code').value.trim()
				const out = document.getElementById('verify-result')
				if (!/^[0-9]{6}$/.test(code)) { out.textContent = 'Code invalide'; return }
				out.textContent = 'Vérification...'
				try {
					const res = await fetch('/auth/api/2fa/verify', {
						method: 'POST',
						credentials: 'include',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ twofa_code: code })
					})
					const json = await res.json().catch(() => ({}))
					if (!res.ok) { out.textContent = 'Erreur: ' + (json.error || res.status); return }
					// if server returns final token, show payload
					if (json.token) {
						let payload = {}
						try { payload = JSON.parse(atob((json.token || '').split('.')[1] || '')) } catch {}
						out.textContent = '2FA validée. Authentifié.'
						console.log('token payload', payload)
					} else {
						out.textContent = '2FA validée.'
					}
				} catch (e) { out.textContent = 'Erreur: ' + e.message }
			})
		</script>
	</body>
</html>
