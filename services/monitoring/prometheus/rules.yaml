groups:
  - name: service_availability
    rules:
      - alert: ServiceDown
        expr: up{job!="prometheus"} == 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: 'Service {{ $labels.job }} is down'
          description: 'The service {{ $labels.job }} has not responded to Prometheus scrapes.'

  - name: high_request_rate
    rules:
      - alert: HighRequestRate
        expr: sum by(route) (rate(http_requests_total[1m])) > 500
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: 'High rate of HTTP requests on route {{ $labels.route }}'
          description: 'The rate of HTTP requests has exceeded 500 requests per minute on route {{ $labels.route }}.'

  - name: nginx_5xx_errors
    rules:
      - alert: Nginx_5xx_Error
        expr: nginx_http_requests_total{code=~"5.."} > 0
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: 'HTTP {{$labels.code}} error on Nginx'
          description: 'A {{$labels.code}} error occurred on route {{ $labels.method }} {{ $labels.route }}.'

  - name: nodejs_event_loop_lag
    rules:
      - alert: EventLoopLagHigh
        expr: nodejs_eventloop_lag_mean_seconds * 1000 > 100
        for: 30s
        labels:
          severity: warning
        annotations:
          summary: 'High NodeJS event loop lag'
          description: 'Event loop lag exceeds 100ms for {{ $labels.job }}.'

  - name: resource_utilization
    rules:
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total[1m]) * 100 > 90
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'High CPU usage'
          description: 'CPU usage exceeds 90% for the last minute.'

      - alert: NodeJSHeapGrowing
        expr: (nodejs_heap_size_used_bytes - nodejs_heap_size_used_bytes offset 10m) / nodejs_heap_size_total_bytes * 100 > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'NodeJS heap is growing'
          description: 'Heap usage increased by more than 10% over the last 10 minutes for {{ $labels.job }}. Possible memory leak.'

  - name: failed_login_attempts
    rules:
      - alert: HighFailedLoginAttempts
        expr: increase(failed_login_attempts_total[5m]) > 20
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High number of failed login attempts'
          description: 'More than 20 failed login attempts in the last 5 minutes.'

      - alert: AdminFailedLoginAttempts
        expr: increase(failed_login_attempts_total{role="admin"}[5m]) > 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'High number of failed admin login attempts'
          description: 'A failed admin login attempts in the last 5 minutes.'
